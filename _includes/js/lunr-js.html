{%- assign fields = site.data.config-search -%}
{%- assign index_fields = fields | where: 'index','true' -%}
<script src="{{ '/assets/lib/lunr.min.js' | relative_url }}"></script>
<script src="{{ '/assets/js/lunr-store.js' | relative_url }}"></script>
<script>
var idx; // Declare idx globally

/* Function to initialize lunr index */
async function initializeLunrIndex() {
  // Wait for transcript text to load
  await new Promise(resolve => setTimeout(resolve, 1500));
  
  /* initialize lunr */
  idx = lunr(function () {
    /* add index fields from config */
    this.ref('id')
    {% for f in index_fields %}
    this.field({{ f.field | jsonify }})
    {% endfor %}
    // Add transcript text field
    this.field('transcript_text')

    //this.pipeline.remove(lunr.trimmer)

    for (var item in store) {
      this.add({
        {% for f in index_fields %}
        {{ f.field | jsonify }}: store[item][{{ f.field | jsonify }}],
        {% endfor %}
        transcript_text: store[item].transcript_text || '',
        id: item
      })
    }

  });
  
  console.log('Lunr index initialized with transcript text');
  
  /* init search box and get query string */
  if (window.location.search) {
    var queryString = decodeURIComponent(window.location.search.substring(1).split("=")[1]);
    document.querySelector('#lunrSearchBox').value = queryString;
    lunr_search();
  }
}

/* search function */
function lunr_search () {
  if (!idx) {
    console.log('Search index not ready yet, please wait...');
    document.querySelector('#lunrResults').innerHTML = '<tr><td><p class="text-muted">Loading search index...</p></td></tr>';
    return;
  }
  
  var resultdiv = document.querySelector('#lunrResults');
  var query = document.querySelector('#lunrSearchBox').value;//.toLowerCase();
  
  /* MODIFIED: Keyword search with OR logic */
  // Split query into individual keywords
  var keywords = query.trim().split(/\s+/);
  
  // Build Lunr query: search for ANY keyword
  var result = idx.query(function (q) {
    keywords.forEach(function (term) {
      if (term && term.length > 0) {
        // Search for exact term with boost
        q.term(term, { boost: 100 });
        // Also search with wildcard for partial matches
        q.term(term, { usePipeline: false, wildcard: lunr.Query.wildcard.TRAILING, boost: 10 });
        // Fuzzy search for typos
        q.term(term, { usePipeline: false, editDistance: 1, boost: 1 });
      }
    });
  });
  
  /* Original basic search (commented out):
  var result = idx.search(query); 
  */
  
  resultdiv.innerHTML = "";
  var newresults = '<tr><td><h4 class="mt-3">' + result.length + ' Result(s) found</h4></td></tr>';
  for (var item in result) {
    var ref = result[item].ref;
    var searchitem =
      '<tr>'+
          '<td>' +
            {% assign display = fields | where: 'display','true' %}
            {% for d in display %}
            {% if forloop.first %}
            '<p class="h4"><a href="{{ site.baseurl }}/items/' + store[ref].id + '">' + store[ref][{{ fields[0].field | jsonify }}]  + '</a></p>' +
            '<p class="ms-3">';
              {% else %}
              if(store[ref][{{ d.field | jsonify }}]) {
                searchitem += store[ref][{{ d.field | jsonify }}] + '<br> '; }
              {% endif %}{% endfor %}
              searchitem += '</p></td>' +
      '</tr>';
    newresults += searchitem;
  }
  resultdiv.innerHTML = newresults;
}

/* Initialize the index when page loads */
initializeLunrIndex();
</script>