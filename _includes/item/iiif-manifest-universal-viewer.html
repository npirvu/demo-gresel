{% comment %}
Embed Universal Viewer loading item from IIIF manifest. Each annotation = article.
{% endcomment %}

<link rel="stylesheet" href="https://viewer.library.wales/viewer-custom.css"/>
<script src="https://cdn.jsdelivr.net/npm/universalviewer@4.0.0/dist/umd/UV.js"></script>

<!-- Viewer -->
<div class="uv" id="uv" style="width: 100%; height: 668px;"></div>

<!-- Botones de artículos (generados dinámicamente) -->
<div id="article-buttons"></div>

<!-- Contenidos de artículos (generados dinámicamente) -->
<div id="article-contents"></div>

<script>
var uvOptions = {
    manifest: "{{ page.object_location | relative_url }}",
    locale: "en-GB",
    config: {
        modules: {
            contentLeftPanel: { options: { panelOpen: true } },
            contentRightPanel: { options: { panelOpen: true, defaultTab: "text" } }
        }
    }
};

var iiif_viewer = UV.init("uv", uvOptions);

document.addEventListener("uv-loaded", function() {
    var uvViewer = iiif_viewer;
    var osdViewer = uvViewer.osd;

    // -----------------------------
    // Aquí van tus anotaciones
    // Cada anotación = artículo
    // Debe tener id, contenido y bloques con coordenadas normalizadas
    // -----------------------------
    var annotations = [
        {
            id: "ART1",
            content: "Texto completo de la anotación/artículo 1",
            blocks: [
                { x:0.02, y:0.26, w:0.19, h:1.06 }
            ]
        },
        {
            id: "ART2",
            content: "Texto completo de la anotación/artículo 2",
            blocks: [
                { x:0.25, y:0.26, w:0.19, h:1.06 }
            ]
        }
        // agrega más anotaciones según tu JSON
    ];

    var articles = {};

    var buttonsContainer = document.getElementById("article-buttons");
    var contentsContainer = document.getElementById("article-contents");

    // Generar overlays, botones y contenidos dinámicamente
    annotations.forEach(function(annot){
        articles[annot.id] = annot;

        // Crear overlay(s)
        annot.blocks.forEach(function(block){
            var overlay = document.createElement('div');
            overlay.className = 'article-segment';
            overlay.setAttribute('article-part', annot.id);

            osdViewer.addOverlay(overlay, new OpenSeadragon.Rect(block.x, block.y, block.w, block.h));

            overlay.addEventListener('mouseover', function() {
                overlay.classList.add('article-hover');
            });
            overlay.addEventListener('mouseout', function() {
                overlay.classList.remove('article-hover');
            });

            overlay.addEventListener('click', function() {
                zoomToArticle(annot.id);
            });
        });

        // Crear botón
        var btn = document.createElement("button");
        btn.setAttribute("data-actuator", annot.id);
        btn.innerText = "Ir a " + annot.id;
        btn.addEventListener('click', function() { zoomToArticle(annot.id); });
        buttonsContainer.appendChild(btn);

        // Crear contenido
        var contentDiv = document.createElement("div");
        contentDiv.id = "content-" + annot.id;
        contentDiv.innerText = annot.content;
        contentsContainer.appendChild(contentDiv);
    });

    // Función de zoom a artículo
    function zoomToArticle(id) {
        var clickedArticle = articles[id];
        if (!clickedArticle) return;

        var blocks = clickedArticle.blocks;
        var startX = Math.min(...blocks.map(b => b.x)) - 0.01;
        var startY = Math.min(...blocks.map(b => b.y)) - 0.01;
        var width  = Math.max(...blocks.map(b => b.w)) + 0.02;
        var height = Math.max(...blocks.map(b => b.h)) + 0.02;

        osdViewer.viewport.fitBounds(new OpenSeadragon.Rect(startX, startY, width, height));

        document.querySelectorAll('.article-segment').forEach(function(el){
            el.classList.remove('active');
        });
        document.querySelectorAll('[article-part="'+id+'"]').forEach(function(el){
            el.classList.add('active');
        });
    }

    // Función copiar al portapapeles
    window.copyToClipboard = function(article) {
        var copyText = document.getElementById("content-" + article);
        if (!copyText) return;
        var text = copyText.innerText;
        var textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("Copy");
        document.body.removeChild(textArea);
        alert("Texto de " + article + " copiado al portapapeles");
    }

    // Zoom inicial al primer artículo
    if (annotations.length > 0) zoomToArticle(annotations[0].id);
});
</script>
