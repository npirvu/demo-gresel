<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>PDF Viewer (OpenSeadragon)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>

<style>
  #osd {
    width: 100%;
    height: 800px;
    border: 1px solid #88ea1230;
    background: #171717;
  }

  #osd-controls {
    display: flex;
    align-items: center;
    gap: 0.25em;
    padding: 0.25em;
    background: #1f1f1f;
    border: 1px solid #333;
    border-radius: 6px;
    margin-bottom: 0.4em;
  }

  #osd-controls button {
    background: #2a2a2a;
    color: #eee;
    border: 1px solid #444;
    padding: 0.15em 0.4em;
    font-size: 0.8em;
    line-height: 1;
    border-radius: 4px;
  }

  #osd-controls button:hover { background: #3a3a3a; }

  #page-indicator { color: #bbb; font-size: 0.75em; margin-left: auto; }

  .article-segment.article-hover {
    border: 2px solid rgba(96, 132, 5, 0.457);
    background: rgba(127, 175, 7, 0.463);
  }

  .article-segment.active {
    border-color: rgba(31, 135, 0, 0.523);
    background: rgba(27, 108, 2, 0.423);
  }

  #article-buttons button {
    display: block;
    width: 100%;
    padding: 0.3em 0.6em;    
    margin-bottom: 0.15em;
    text-align: left;
    background: rgba(234, 238, 225, 0.85);
    border: 1px solid rgba(84, 114, 6, 0.35);
    border-radius: 3px;
    cursor: pointer;
    font-weight: 500;       
    font-size: 0.85em;      
    line-height: 1.2;
  }

  #article-buttons button:hover { background: rgba(210, 220, 190, 0.9); }

  .article-content {
    white-space: pre-wrap;
    max-height: 0px;          
    overflow-y: auto;           
    overflow-x: hidden;         
    opacity: 0;
    padding: 0 1em;
    border-left: 3px solid rgba(131, 232, 0, 0.341);
    font-size: 0.85em;
    line-height: 1.4;
    transition: max-height 0.35s ease, opacity 0.25s ease, padding 0.25s ease;
  }

  .article-content.open {
    max-height: 500px;           
    opacity: 1;
    padding: 0.5em 1em;
  }
</style>
</head>

<body>

<div id="osd-controls">
  <button id="prev-page">Anterior</button>
  <button id="next-page">Siguiente</button>
  <span id="page-indicator">Página 1 / N</span>
</div>

<div id="osd"></div>

<h3>Transcripciones OCR</h3>
<div id="article-buttons"></div>

<script>
let viewer;
let pages = [];
let currentPage = 0;
const PDF_JSON = "objects/la-vanguardia/13-04-1944/La_Vanguardia_13-04-1944_osd.json";

// ================================
// INIT
// ================================
async function init() {
  const data = await (await fetch(PDF_JSON)).json();
  pages = data.pages;

  viewer = OpenSeadragon({
    id: "openseadragon1",
    prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
    showNavigator: true
  });

  document.getElementById("prev-page").onclick = () => {
    if (currentPage > 0) loadPage(currentPage - 1);
  };

  document.getElementById("next-page").onclick = () => {
    if (currentPage < pages.length - 1) loadPage(currentPage + 1);
  };

  loadPage(0);
}

// ================================
// LOAD PAGE
// ================================
function loadPage(index) {
  currentPage = index;
  const page = pages[index];

  viewer.open(new OpenSeadragon.ImageTileSource({
    type: 'image',
    url: page.image,
    buildPyramid: false
  }));

  viewer.addOnceHandler("open", () => {
    viewer.clearOverlays();
    if(page.annotations) renderArticles(viewer, page.annotations);

    document.getElementById("page-indicator").textContent =
      `Página ${index + 1} / ${pages.length}`;
  });
}

// ================================
// RENDER ANNOTATIONS
// ================================
function renderArticles(viewer, annotations) {
  const container = document.getElementById("article-buttons");
  container.innerHTML = "";

  let counter = 1;

  for (const ann of annotations) {
    const artId = "ART" + counter;

    // Crear overlay
    const overlay = document.createElement("div");
    overlay.className = "article-segment";
    overlay.dataset.art = artId;

    // Calcular bounding box
    const xs = ann.points.map(p => p[0]);
    const ys = ann.points.map(p => p[1]);
    const x = Math.min(...xs);
    const y = Math.min(...ys);
    const w = Math.max(...xs) - x;
    const h = Math.max(...ys) - y;

    const tiledImage = viewer.world.getItemAt(0);
    const viewportRect = tiledImage.imageToViewportRectangle(
      new OpenSeadragon.Rect(x, y, w, h)
    );

    viewer.addOverlay({ element: overlay, location: viewportRect });

    overlay.addEventListener("mouseenter", () => overlay.classList.add("article-hover"));
    overlay.addEventListener("mouseleave", () => overlay.classList.remove("article-hover"));

    new OpenSeadragon.MouseTracker({
      element: overlay,
      clickHandler: () => {
        zoomToArticle(viewer, { xywh: { x, y, w, h }, id: artId });
        toggleArticleContent(artId);
      }
    });

    // Crear botón y contenido OCR
    const wrapper = document.createElement("div");
    const btn = document.createElement("button");
    btn.textContent = artId;
    btn.onclick = () => {
      zoomToArticle(viewer, { xywh: { x, y, w, h }, id: artId });
      toggleArticleContent(artId);
    };

    const content = document.createElement("div");
    content.className = "article-content";
    content.textContent = ann.text || "";
    content.dataset.art = artId;

    wrapper.appendChild(btn);
    wrapper.appendChild(content);
    container.appendChild(wrapper);

    counter++;
  }
}

// ================================
// ZOOM
// ================================
function zoomToArticle(viewer, article) {
  const r = article.xywh;
  const tiledImage = viewer.world.getItemAt(0);
  const viewportRect = tiledImage.imageToViewportRectangle(
    new OpenSeadragon.Rect(r.x, r.y, r.w, r.h)
  );

  viewer.viewport.fitBounds(viewportRect, true);

  document.querySelectorAll(".article-segment").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(`[data-art]`).forEach(el => {
    if (el.dataset.art === article.id) el.classList.add("active");
  });
}

// ================================
// TOGGLE OCR
// ================================
function toggleArticleContent(artId) {
  document.querySelectorAll(".article-content").forEach(el => {
    el.classList.toggle("open", el.dataset.art === artId && !el.classList.contains("open"));
  });
}

// ================================
// START
// ================================
init();
</script>

</body>
</html>
