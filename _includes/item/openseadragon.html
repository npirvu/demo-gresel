<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>IIIF Articles Viewer (OpenSeadragon)</title>

<link rel="stylesheet" href="https://viewer.library.wales/viewer-custom.css">
<script src="https://cdn.jsdelivr.net/npm/universalviewer@4.0.0/dist/umd/UV.js"></script>

<!-- Your custom UV CSS -->
<link rel="stylesheet" href="https://viewer.library.wales/viewer-custom.css">

<style>
  #uv {
    width: 100%;
    height: 700px;
  }

  .article-segment {
    position: absolute;
    border: 2px solid rgba(255,0,0,0.6);
    background: rgba(255,0,0,0.15);
    cursor: pointer;
  }

  .article-segment:hover {
    background: rgba(255,0,0,0.3);
  }

  .article-segment.active {
    border-color: blue;
    background: rgba(0,0,255,0.2);
  }

  #article-buttons {
    margin-top: 1em;
  }

  #article-buttons button {
    margin-bottom: 0.3em;
    display: block;
  }

  .article-content {
    margin-left: 1em;
    display: none;
  }
</style>
</head>

<body>

<h2>IIIF Viewer with OCR Articles</h2>

<div id="uv"></div>

<h3>OCR Transcriptions</h3>
<div id="article-buttons"></div>

<script>
const MANIFEST_URL = "{{ page.object_location | relative_url }}";

const uv = UV.init("uv", {
  manifest: MANIFEST_URL,
  locale: "en-GB"
});

uv.on("open", async function () {

  // ðŸ”¹ Access internal OpenSeadragon
  const viewer = uv.getViewer();

  // ðŸ”¹ Load manifest
  const manifest = await (await fetch(MANIFEST_URL)).json();
  const canvas = manifest.sequences[0].canvases[0];

  const articles = await loadAnnotations(canvas);
  renderArticles(viewer, articles);
});

/* ================================
   LOAD IIIF v2 ANNOTATIONS
================================ */
async function loadAnnotations(canvas) {
  const articles = {};
  const pages = canvas.otherContent || [];
  let counter = 1;

  for (const page of pages) {
    const pageData = await (await fetch(page['@id'] || page.id)).json();
    const annotations = pageData.resources || [];

    for (const ann of annotations) {

      const text = ann.resource?.chars || "Sin texto";
      const on = ann.on || "";

      const m = on.match(/xywh=(\d+),(\d+),(\d+),(\d+)/);
      if (!m) continue;

      const x = parseInt(m[1]);
      const y = parseInt(m[2]);
      const w = parseInt(m[3]);
      const h = parseInt(m[4]);

      const id = "ART" + counter;

      articles[id] = {
        id,
        text,
        block: {
          x: x / canvas.width,
          y: y / canvas.height,
          w: w / canvas.width,
          h: h / canvas.height
        }
      };

      counter++;
    }
  }

  return articles;
}

/* ================================
   RENDER ARTICLES
================================ */
function renderArticles(viewer, articles) {
  const container = document.getElementById("article-buttons");
  container.innerHTML = "";

  for (const key in articles) {
    const art = articles[key];

    // ðŸ”¹ Overlay
    const overlay = document.createElement("div");
    overlay.className = "article-segment";
    overlay.dataset.article = art.id;

    viewer.addOverlay({
      element: overlay,
      location: new OpenSeadragon.Rect(
        art.block.x,
        art.block.y,
        art.block.w,
        art.block.h
      )
    });

    overlay.onclick = () => zoomToArticle(viewer, art);

    // ðŸ”¹ Button + expandable text
    const wrapper = document.createElement("div");

    const btn = document.createElement("button");
    btn.textContent = art.id;
    btn.onclick = () => {
      zoomToArticle(viewer, art);
      content.style.display =
        content.style.display === "none" ? "block" : "none";
    };

    const content = document.createElement("div");
    content.className = "article-content";
    content.textContent = art.text;

    wrapper.appendChild(btn);
    wrapper.appendChild(content);
    container.appendChild(wrapper);
  }
}

/* ================================
   ZOOM
================================ */
function zoomToArticle(viewer, article) {
  const b = article.block;
  const rect = new OpenSeadragon.Rect(
    b.x - 0.01,
    b.y - 0.01,
    b.w + 0.02,
    b.h + 0.02
  );

  viewer.viewport.fitBounds(rect);

  document.querySelectorAll(".article-segment")
    .forEach(el => el.classList.remove("active"));

  document.querySelectorAll(`[data-article="${article.id}"]`)
    .forEach(el => el.classList.add("active"));
}
</script>

</body>
</html>