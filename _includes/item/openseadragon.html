<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>IIIF Articles Viewer (OpenSeadragon)</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>

<style>
  #osd { width: 100%; height: 700px; border: 1px solid #ccc; }
  .article-segment {
    border: 2px solid rgba(255,0,0,0.6);
    background: rgba(255,0,0,0.15);
    cursor: pointer;
    position: absolute;
  }
  .article-segment.article-hover { background: rgba(255,0,0,0.3); }
  .article-segment.active { border-color: blue; background: rgba(0,0,255,0.2); }
  #article-buttons button { margin: 0.2em; }
  #article-contents { margin-top: 1em; padding: 0.5em; border: 1px solid #ccc; }
</style>
</head>

<body>

<h2>IIIF Articles Viewer</h2>
<div id="osd"></div>

<h3>OCR Transcriptions</h3>
<div id="article-buttons"></div>


<script>
const MANIFEST_URL = "{{ page.object_location || relative_url }}";  // tu manifest IIIF

async function init() {

  // 1️⃣ Cargar manifest
  const manifestResp = await fetch(MANIFEST_URL);
  const manifest = await manifestResp.json();

  // 2️⃣ Obtener info.json del primer canvas
  const canvas = manifest.sequences[0].canvases[0];
  const image = canvas.images[0].resource;
  const service = Array.isArray(image.service) ? image.service[0] : image.service;
  const infoJsonUrl = (service['@id'] || service.id) + "/info.json";

  console.log("INFO.JSON:", infoJsonUrl);

  // 3️⃣ Inicializar OpenSeadragon
  const viewer = OpenSeadragon({
    id: "osd",
    prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
    tileSources: infoJsonUrl,
    showNavigator: true
  });

  viewer.addHandler("open", async () => {
    const articles = await loadAnnotations(canvas);
    console.log("ARTICLES PARSED:", articles);
    renderArticles(viewer, articles);
  });
}

// ================================
// CARGA ANOTACIONES V2
// ================================
async function loadAnnotations(canvas) {
  const articles = {};

  const pages = canvas.otherContent || [];

  for (const page of pages) {
    // Traer archivo JSON de anotaciones
    const pageData = await (await fetch(page['@id'] || page.id)).json();
    const annotations = pageData.resources || [];

    for (const ann of annotations) {
      const id = ann['@id'] || ann.id;

      // texto
      const text = ann.resource?.chars || "Sin texto";

      // xywh en la URL
      const on = ann.on || "";
      const m = on.match(/xywh=(\d+),(\d+),(\d+),(\d+)/);
      if (!m) continue;

      const x = parseInt(m[1]);
      const y = parseInt(m[2]);
      const w = parseInt(m[3]);
      const h = parseInt(m[4]);

      const block = {
        x: x / canvas.width,
        y: y / canvas.height,
        w: w / canvas.width,
        h: h / canvas.height
      };

      articles[id] = { id, text, block };
    }
  }

  return articles;
}

// ================================
// RENDER
// ================================
function renderArticles(viewer, articles) {
  const container = document.getElementById("article-buttons");
  container.innerHTML = ""; // limpiar

  let counter = 1;

  for (const id in articles) {
    const art = articles[id];

    const artId = "ART" + counter; // nombre numerado

    // Overlay
    const overlay = document.createElement("div");
    overlay.className = "article-segment";
    overlay.setAttribute("article-part", id);

    viewer.addOverlay({
      element: overlay,
      location: new OpenSeadragon.Rect(
        art.block.x,
        art.block.y,
        art.block.w,
        art.block.h
      )
    });

    overlay.addEventListener("mouseover", () => overlay.classList.add("article-hover"));
    overlay.addEventListener("mouseout", () => overlay.classList.remove("article-hover"));
    overlay.addEventListener("click", () => zoomToArticle(viewer, art));

    // Crear contenedor de botón + contenido
    const wrapper = document.createElement("div");
    wrapper.style.marginBottom = "0.5em";

    // Botón numerado
    const btn = document.createElement("button");
    btn.textContent = artId;
    btn.style.display = "block";
    btn.onclick = () => {
      zoomToArticle(viewer, art);
      const contentDiv = wrapper.querySelector(".article-content");
      contentDiv.style.display = contentDiv.style.display === "none" ? "block" : "none";
    };
    wrapper.appendChild(btn);

    // Contenido debajo del botón
    const contentDiv = document.createElement("div");
    contentDiv.className = "article-content";
    contentDiv.textContent = art.text;
    contentDiv.style.display = "none"; // inicialmente oculto
    contentDiv.style.marginLeft = "1em";
    wrapper.appendChild(contentDiv);

    container.appendChild(wrapper);

    counter++;
  }
}


// ================================
// ZOOM A ARTÍCULO
// ================================
function zoomToArticle(viewer, article) {
  const b = article.block;
  const rect = new OpenSeadragon.Rect(
    b.x - 0.01,
    b.y - 0.01,
    b.w + 0.02,
    b.h + 0.02
  );
  viewer.viewport.fitBounds(rect);

  document.querySelectorAll(".article-segment").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(`[article-part="${article.id}"]`).forEach(el => el.classList.add("active"));
}

// ================================
// ARRANQUE
// ================================
init();
</script>

</body>
</html>
