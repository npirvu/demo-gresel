<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>IIIF Articles Viewer (OpenSeadragon)</title>

<!-- OpenSeadragon -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>

<!-- Tu CSS -->
<link rel="stylesheet" href="https://viewer.library.wales/viewer-custom.css"/>

<style>
  .article-segment {
    border: 2px solid rgba(255,0,0,0.6);
    background: rgba(255,0,0,0.15);
    cursor: pointer;
  }

  .article-segment.article-hover {
    background: rgba(255,0,0,0.3);
  }

  .article-segment.active {
    border-color: blue;
    background: rgba(0,0,255,0.2);
  }

  #article-buttons button {
    margin: 0.2em;
  }

  #article-contents {
    margin-top: 1em;
  }
</style>
</head>

<body>

<div id="osd" style="width:100%; height:700px;"></div>

<h3>Artículos</h3>
<div id="article-buttons"></div>

<h3>Contenido</h3>
<div id="article-contents"></div>

<script>
/* ================================
   CONFIG
================================ */
const MANIFEST_URL = "{{ page.object_location | relative_url }}";

/* ================================
   INIT
================================ */
async function init() {

  /* 1. Cargar manifest */
  const manifestResp = await fetch(MANIFEST_URL);
  const manifest = await manifestResp.json();

  /* 2. Sacar info.json automáticamente */
  const canvases = manifest.items || manifest.sequences[0].canvases;
  const canvas = canvases[0];

  const image =
    canvas.items?.[0]?.items?.[0]?.body ||   // IIIF v3
    canvas.images?.[0]?.resource;            // IIIF v2

  const service = Array.isArray(image.service)
    ? image.service[0]
    : image.service;

  const canvas = manifest.items[0];
  const imageService =
    canvas.items[0].items[0].body.service[0]['@id'];

  const INFO_JSON_URL = imageService + "/info.json";

  /* 3. Inicializar OpenSeadragon */
  const viewer = OpenSeadragon({
    id: "osd",
    prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
    tileSources: infoJsonUrl,
    showNavigator: true,
    showRotationControl: true
  });

  viewer.addHandler("open", async () => {
    const response = await fetch(MANIFEST_URL);
    const manifest = await response.json();

    const articles = await loadAnnotations(manifest);
    console.log("FINAL ARTICLES:", articles);

    renderArticles(articles);
  });
}

/* ================================
   ANNOTATIONS = ARTÍCULOS
================================ */
async function loadAnnotations(manifest) {

  const articles = {};
  const canvases = manifest.items || manifest.sequences[0].canvases;

  for (const canvas of canvases) {

    const pages =
      canvas.annotations ||    // v3
      canvas.otherContent ||   // v2
      [];

    for (const page of pages) {

      const pageData = page.items
        ? page
        : await (await fetch(page.id || page['@id'])).json();

      const annotations = pageData.items || pageData.resources || [];

      for (const ann of annotations) {

        const id = ann.id || ann['@id'];

        const body = Array.isArray(ann.body) ? ann.body[0] : ann.body;
        const text = body?.value || "Sin texto";

        const target = ann.target || ann.on;

        let selector = null;

        // Caso Recogito / IIIF v2 (selector es array)
        if (target?.selector) {
        if (Array.isArray(target.selector)) {
            selector = target.selector[0].value;
        } else {
            selector = target.selector.value;
        }
        }
        // Fallbacks
        else if (typeof target === "string") {
        selector = target;
        }

        if (!selector) continue;


        const m = selector.match(/xywh=pixel:(\d+),(\d+),(\d+),(\d+)/);
        if (!m) continue;

        const x = parseInt(m[1]);
        const y = parseInt(m[2]);
        const w = parseInt(m[3]);
        const h = parseInt(m[4]);

        const block = {
          x: x / canvas.width,
          y: y / canvas.height,
          w: w / canvas.width,
          h: h / canvas.height
        };

        articles[id] = { id, text, block };
      }
    }
  }
  console.log("ARTICLES PARSED:", articles);
  return articles;
}

/* ================================
   RENDER
================================ */
function renderArticles(viewer, articles) {

  const buttons = document.getElementById("article-buttons");
  const contents = document.getElementById("article-contents");

  for (const id in articles) {
    const art = articles[id];

    /* Overlay */
    const overlay = document.createElement("div");
    overlay.className = "article-segment";
    overlay.setAttribute("article-part", id);

    const imageRect = viewer.viewport.imageToViewportRectangle(
      art.block.x * viewer.world.getItemAt(0).getContentSize().x,
      art.block.y * viewer.world.getItemAt(0).getContentSize().y,
      art.block.w * viewer.world.getItemAt(0).getContentSize().x,
      art.block.h * viewer.world.getItemAt(0).getContentSize().y
    )

    viewer.addOverlay({
      element: overlay,
      location: imageRect
    });

    overlay.onmouseover = () => overlay.classList.add("article-hover");
    overlay.onmouseout  = () => overlay.classList.remove("article-hover");
    overlay.onclick     = () => zoomToArticle(viewer, art);

    /* Botón */
    const btn = document.createElement("button");
    btn.textContent = id;
    btn.onclick = () => zoomToArticle(viewer, art);
    buttons.appendChild(btn);

    /* Contenido */
    const div = document.createElement("div");
    div.id = "content-" + id;
    div.textContent = art.text;
    contents.appendChild(div);
  }
}

/* ================================
   ZOOM
================================ */
function zoomToArticle(viewer, article) {

  const b = article.block;
  const rect = new OpenSeadragon.Rect(
    b.x - 0.01,
    b.y - 0.01,
    b.w + 0.02,
    b.h + 0.02
  );

  viewer.viewport.fitBounds(rect);

  document.querySelectorAll(".article-segment")
    .forEach(el => el.classList.remove("active"));

  document.querySelectorAll(`[article-part="${article.id}"]`)
    .forEach(el => el.classList.add("active"));
}

/* ================================
   START
================================ */
init();
</script>

</body>
</html>
