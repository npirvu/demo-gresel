<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>IIIF Articles Viewer (OpenSeadragon)</title>

<link rel="stylesheet" href="https://viewer.library.wales/viewer-custom.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>

<style>
  #osd {
    width: 100%;
    height: 700px;
    border: 1px solid #ccc;
  }

  .article-segment {
    border: 2px solid rgba(255,0,0,0.6);
    background: rgba(255,0,0,0.15);
    cursor: pointer;
    position: absolute;
  }

  .article-segment.article-hover {
    background: rgba(255,0,0,0.3);
  }

  .article-segment.active {
    border-color: blue;
    background: rgba(0,0,255,0.2);
  }

  #article-buttons button {
    margin: 0.2em;
    display: block;
  }

  .article-content {
    margin-left: 1em;
    display: none;
  }
</style>
</head>

<body>

<h2>IIIF Articles Viewer</h2>
<div id="osd"></div>

<h3>OCR Transcriptions</h3>
<div id="article-buttons"></div>

<script>
const MANIFEST_URL = "{{ page.object_location || relative_url }}";

async function init() {

  // 1️⃣ Cargar manifest
  const manifest = await (await fetch(MANIFEST_URL)).json();

  // 2️⃣ Primer canvas
  const canvas = manifest.sequences[0].canvases[0];

  // 3️⃣ info.json de la imagen
  const image = canvas.images[0].resource;
  const service = Array.isArray(image.service) ? image.service[0] : image.service;
  const infoJsonUrl = (service['@id'] || service.id) + "/info.json";
  const info = await (await fetch(infoJsonUrl)).json();

  const imgWidth = info.width;
  const imgHeight = info.height;

  // 4️⃣ OpenSeadragon
  const viewer = OpenSeadragon({
    id: "osd",
    prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
    tileSources: infoJsonUrl,
    showNavigator: true
  });

  viewer.addHandler("open", async () => {
    const articles = await loadAnnotations(canvas);
    console.log("ARTICLES PARSED:", articles);
    renderArticles(viewer, articles);
  });
}

// ================================
// CARGA ANOTACIONES IIIF v2
// ================================
async function loadAnnotations(canvas) {
  const articles = {};
  const pages = canvas.otherContent || [];

  const canvasWidth = canvas.width;
  const canvasHeight = canvas.height;

  for (const page of pages) {
    const pageData = await (await fetch(page['@id'] || page.id)).json();
    const annotations = pageData.resources || [];

    for (const ann of annotations) {
      const id = ann['@id'] || ann.id;
      const text = ann.resource?.chars || "Sin texto";

      const on = ann.on || "";
      const m = on.match(/xywh=pixel:(\d+),(\d+),(\d+),(\d+)/);
      if (!m) continue;

      const x = parseInt(m[1], 10);
      const y = parseInt(m[2], 10);
      const w = parseInt(m[3], 10);
      const h = parseInt(m[4], 10);

      articles[id] = {
        id,
        text,
        block: {
          x: x / canvasWidth,
          y: y / canvasHeight,
          w: w / canvasWidth,
          h: h / canvasHeight
        }
      };
    }
  }

  return articles;
}


// ================================
// RENDER
// ================================
function renderArticles(viewer, articles) {
  const container = document.getElementById("article-buttons");
  container.innerHTML = "";

  let counter = 1;

  for (const id in articles) {
    const art = articles[id];
    const artId = "ART" + counter;

    // Overlay
    const overlay = document.createElement("div");
    overlay.className = "article-segment";
    overlay.setAttribute("article-part", id);

    viewer.addOverlay({
      element: overlay,
      location: new OpenSeadragon.Rect(
        art.block.x,
        art.block.y,
        art.block.w,
        art.block.h
      )
    });

    overlay.addEventListener("mouseover", () => overlay.classList.add("article-hover"));
    overlay.addEventListener("mouseout", () => overlay.classList.remove("article-hover"));
    overlay.addEventListener("click", () => zoomToArticle(viewer, art));

    // UI
    const wrapper = document.createElement("div");

    const btn = document.createElement("button");
    btn.textContent = artId;
    btn.onclick = () => {
      zoomToArticle(viewer, art);
      content.style.display = content.style.display === "none" ? "block" : "none";
    };

    const content = document.createElement("div");
    content.className = "article-content";
    content.textContent = art.text;

    wrapper.appendChild(btn);
    wrapper.appendChild(content);
    container.appendChild(wrapper);

    counter++;
  }
}

// ================================
// ZOOM
// ================================
function zoomToArticle(viewer, article) {
  const b = article.block;
  const rect = new OpenSeadragon.Rect(
    b.x - 0.01,
    b.y - 0.01,
    b.w + 0.02,
    b.h + 0.02
  );

  viewer.viewport.fitBounds(rect);

  document.querySelectorAll(".article-segment")
    .forEach(el => el.classList.remove("active"));

  document.querySelectorAll(`[article-part="${article.id}"]`)
    .forEach(el => el.classList.add("active"));
}

// ================================
// ARRANQUE
// ================================
init();
</script>

</body>
</html>
