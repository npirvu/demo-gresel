<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>IIIF Articles Viewer (OpenSeadragon)</title>

<link rel="stylesheet" href="https://viewer.library.wales/viewer-custom.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>

<style>
  #osd {
    width: 100%;
    height: 800px;
    border: 1px solid #88ea1230;
    background: #171717
  }

  .article-segment.article-hover {
    border: 2px solid rgba(96, 132, 5, 0.463);
    background: rgba(127, 175, 7, 0.463);
  }

  .article-segment.active {
    border-color: rgba(31, 135, 0, 0.523);
    background: rgba(27, 108, 2, 0.423);
  }

  #article-buttons button {
    display: block;
    width: 100%;
    padding: 0.6em 0.8em;
    margin-bottom: 0.2em;
    text-align: left;
    background: rgba(234, 238, 225, 0.763);
    border: 1px solid rgba(84, 114, 6, 0.392);
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
  }

  .article-content {
    display: none;
    padding: 0.5em 1em;
    border-left: 3px solid rgba(131, 232, 0, 0.341);
    text-align: left;
  }

</style>
</head>

<body>

<h2>IIIF Articles Viewer</h2>    

<div id="osd-controls">
  <button id="prev-page">Anterior</button>
  <button id="next-page">Siguiente</button>
  <span id="page-indicator">Página 1 / N</span>
</div>

<div id="osd"></div>

<h3>OCR Transcriptions</h3>
<div id="article-buttons"></div>

<script>
const MANIFEST_URL = "{{ page.object_location || relative_url }}";

async function init() {

  // 1️⃣ Cargar manifest
  const manifest = await (await fetch(MANIFEST_URL)).json();

  // 2️⃣ Primer canvas
  const canvas = manifest.sequences[0].canvases[0];

  // 3️⃣ info.json de la imagen
  const image = canvas.images[0].resource;
  const service = Array.isArray(image.service) ? image.service[0] : image.service;
  const infoJsonUrl = (service['@id'] || service.id) + "/info.json";
  const info = await (await fetch(infoJsonUrl)).json();

  const imgWidth = info.width;
  const imgHeight = info.height;

  // 4️⃣ OpenSeadragon
  const viewer = OpenSeadragon({
    id: "osd",
    prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
    tileSources: infoJsonUrl,
    showNavigator: true
  });

  viewer.addHandler("open", async () => {
    const articles = await loadAnnotations(canvas);
    console.log("ARTICLES PARSED:", articles);
    renderArticles(viewer, articles);
  });
}

// ================================
// CARGA ANOTACIONES IIIF v2
// ================================
async function loadAnnotations(canvas) {
  const articles = {};
  const pages = canvas.otherContent || [];

  const canvasWidth = canvas.width;
  const canvasHeight = canvas.height;

  for (const page of pages) {
    const pageData = await (await fetch(page['@id'] || page.id)).json();
    const annotations = pageData.resources || [];

    for (const ann of annotations) {
      const id = ann['@id'] || ann.id;
      const text = ann.resource?.chars || "Sin texto";

      const on = ann.on || "";
      const m = on.match(/xywh=pixel:(\d+),(\d+),(\d+),(\d+)/);
      if (!m) continue;

      const x = parseInt(m[1], 10);
      const y = parseInt(m[2], 10);
      const w = parseInt(m[3], 10);
      const h = parseInt(m[4], 10);

    articles[id] = {
      id,
      text,
      xywh: { x, y, w, h }   // ← IMPORTANTE
    };
    }
  }

  return articles;
}


// ================================
// RENDER
// ================================
function renderArticles(viewer, articles) {
  const container = document.getElementById("article-buttons");
  container.innerHTML = "";

  let counter = 1;

  for (const id in articles) {
    const art = articles[id];
    const artId = "ART" + counter;

  // Overlay
  const overlay = document.createElement("div");
    overlay.className = "article-segment";
    overlay.setAttribute("article-part", id);
    overlay.dataset.art = artId;

  const tiledImage = viewer.world.getItemAt(0);
  const { x, y, w, h } = art.xywh;

  const imageRect = new OpenSeadragon.Rect(x, y, w, h);
  const viewportRect = tiledImage.imageToViewportRectangle(imageRect);

  viewer.addOverlay({
    element: overlay,
    location: viewportRect
  });

  overlay.addEventListener("mouseover", () => overlay.classList.add("article-hover"));
  overlay.addEventListener("mouseout", () => overlay.classList.remove("article-hover"));

  new OpenSeadragon.MouseTracker({
    element: overlay,
    clickHandler: function () {
      zoomToArticle(viewer, art);
      toggleArticleContent(artId);
  }
});


  // UI
  const wrapper = document.createElement("div");

  const btn = document.createElement("button");
  btn.textContent = artId;
  btn.onclick = () => {
    zoomToArticle(viewer, art);
    toggleArticleContent(artId);
  };

  const content = document.createElement("div");
  content.className = "article-content";
  content.textContent = art.text;
  content.dataset.art = artId;

  wrapper.appendChild(btn);
  wrapper.appendChild(content);
  container.appendChild(wrapper);

  counter++;
}
}

// ================================
// ZOOM
// ================================
function zoomToArticle(viewer, article) {
  const tiledImage = viewer.world.getItemAt(0);
  const { x, y, w, h } = article.xywh;

  const imageRect = new OpenSeadragon.Rect(x, y, w, h);
  const viewportRect = tiledImage.imageToViewportRectangle(imageRect);

  viewer.viewport.fitBounds(viewportRect, true);

  document.querySelectorAll(".article-segment")
    .forEach(el => el.classList.remove("active"));

  document.querySelectorAll(`[article-part="${article.id}"]`)
    .forEach(el => el.classList.add("active"));
}

function toggleArticleContent(artId) {
  document.querySelectorAll(".article-content").forEach(el => {
    if (el.dataset.art === artId) {
      el.style.display = el.style.display === "block" ? "none" : "block";
    } else {
      el.style.display = "none";
    }
  });
}

// ================================
// ARRANQUE
// ================================
init();
</script>

</body>
</html>
