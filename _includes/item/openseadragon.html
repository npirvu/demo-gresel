<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>IIIF Articles Viewer (OpenSeadragon)</title>

<link rel="stylesheet" href="https://viewer.library.wales/viewer-custom.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>

<style>
  #osd {
    width: 100%;
    height: 800px;
    border: 1px solid #88ea1230;
    background: #171717
  }

  #osd-controls {
    display: flex;
    align-items: center;
    gap: 0.25em;
    padding: 0.25em;
    background: #1f1f1f;
    border: 1px solid #333;
    border-radius: 6px;
    margin-bottom: 0.4em;
  }

  #osd-controls button {
    background: #2a2a2a;
    color: #eee;
    border: 1px solid #444;
    padding: 0.15em 0.4em;
    font-size: 0.8em;
    line-height: 1;
    border-radius: 4px;
  }

  #osd-controls button:hover {
    background: #3a3a3a;
  }

  #page-indicator {
    color: #bbb;
    font-size: 0.75em;
    margin-left: auto;
  }

  .article-segment.article-hover {
    border: 2px solid rgba(96, 132, 5, 0.463);
    background: rgba(127, 175, 7, 0.463);
  }

  .article-segment.active {
    border-color: rgba(31, 135, 0, 0.523);
    background: rgba(27, 108, 2, 0.423);
  }

  #article-buttons button {
    display: block;
    width: 100%;
    padding: 0.3em 0.6em;    
    margin-bottom: 0.15em;
    text-align: left;

    background: rgba(234, 238, 225, 0.85);
    border: 1px solid rgba(84, 114, 6, 0.35);
    border-radius: 3px;

    cursor: pointer;
    font-weight: 500;       
    font-size: 0.85em;      
    line-height: 1.2;
  }

  #article-buttons button:hover {
    background: rgba(210, 220, 190, 0.9);
  }

  .article-content {
    white-space: pre-wrap;
    max-height: 0px;          /* altura m치xima visible */
    overflow-y: auto;           /* a침ade scroll vertical */
    overflow-x: hidden;         /* evita scroll horizontal */
    opacity: 0;
    padding: 0 1em;
    border-left: 3px solid rgba(131, 232, 0, 0.341);
    text-align: left;
    font-size: 0.85em;
    line-height: 1.4;
    transition:
      max-height 0.35s ease,
      opacity 0.25s ease,
      padding 0.25s ease;
  }

  /* estado abierto */
  .article-content.open {
    max-height: 500px;           
    opacity: 1;
    padding: 0.5em 1em;
  }

</style>
</head>

<body>

<h2>IIIF Articles Viewer</h2>    

<div id="osd-controls">
  <button id="prev-page">Anterior</button>
  <button id="next-page">Siguiente</button>
  <span id="page-indicator">P치gina 1 / N</span>
</div>

<div id="osd"></div>

<h3>OCR Transcriptions</h3>
<div id="article-buttons"></div>

<script>
const MANIFEST_URL = "{{ page.object_location || relative_url }}";

let viewer;
let canvases = [];
let currentPage = 0;

// ================================
// INIT
// ================================
async function init() {
  const manifest = await (await fetch(MANIFEST_URL)).json();
  canvases = manifest.sequences[0].canvases;

  viewer = OpenSeadragon({
    id: "osd",
    prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
    showNavigator: true
  });

  document.getElementById("prev-page").onclick = () => {
    if (currentPage > 0) loadPage(currentPage - 1);
  };

  document.getElementById("next-page").onclick = () => {
    if (currentPage < canvases.length - 1) loadPage(currentPage + 1);
  };

  loadPage(0);
}

// ================================
// LOAD PAGE
// ================================
async function loadPage(index) {
  currentPage = index;
  const canvas = canvases[index];

  const image = canvas.images[0].resource;
  const service = Array.isArray(image.service) ? image.service[0] : image.service;
  const infoJsonUrl = (service['@id'] || service.id) + "/info.json";

  viewer.open(infoJsonUrl);

  viewer.addOnceHandler("open", async () => {
    viewer.clearOverlays();

    const articles = await loadAnnotations(canvas);
    renderArticles(viewer, articles);

    document.getElementById("page-indicator").textContent =
      `P치gina ${index + 1} / ${canvases.length}`;
  });
}

// ================================
// LOAD ANNOTATIONS
// ================================
async function loadAnnotations(canvas) {
  const articles = {};
  const pages = canvas.otherContent || [];

  for (const page of pages) {
    const pageData = await (await fetch(page['@id'] || page.id)).json();
    const annotations = pageData.resources || [];

    for (const ann of annotations) {
      const id = ann['@id'] || ann.id;
      const text = ann.resource?.chars || "Sin texto";

      const m = (ann.on || "").match(/xywh=pixel:(\d+),(\d+),(\d+),(\d+)/);
      if (!m) continue;

      articles[id] = {
        id,
        text,
        xywh: {
          x: +m[1],
          y: +m[2],
          w: +m[3],
          h: +m[4]
        }
      };
    }
  }
  return articles;
}

// ================================
// RENDER ARTICLES
// ================================
function renderArticles(viewer, articles) {
  const container = document.getElementById("article-buttons");
  container.innerHTML = "";

  let counter = 1;

  for (const id in articles) {
    const art = articles[id];
    const artId = "ART" + counter;

    const overlay = document.createElement("div");
    overlay.className = "article-segment";
    overlay.dataset.art = artId;
    overlay.setAttribute("article-part", id);

    const tiledImage = viewer.world.getItemAt(0);
    const r = art.xywh;
    const viewportRect = tiledImage.imageToViewportRectangle(
      new OpenSeadragon.Rect(r.x, r.y, r.w, r.h)
    );

    viewer.addOverlay({ element: overlay, location: viewportRect });

    overlay.addEventListener("mouseenter", () => overlay.classList.add("article-hover"));
    overlay.addEventListener("mouseleave", () => overlay.classList.remove("article-hover"));

    new OpenSeadragon.MouseTracker({
      element: overlay,
      clickHandler: () => {
        zoomToArticle(viewer, art);
        toggleArticleContent(artId);
      }
    });

    const wrapper = document.createElement("div");

    const btn = document.createElement("button");
    btn.textContent = artId;
    btn.onclick = () => {
      zoomToArticle(viewer, art);
      toggleArticleContent(artId);
    };

    const content = document.createElement("div");
    content.className = "article-content";
    content.textContent = art.text;
    content.dataset.art = artId;

    wrapper.appendChild(btn);
    wrapper.appendChild(content);
    container.appendChild(wrapper);

    counter++;
  }
}

// ================================
// ZOOM
// ================================
function zoomToArticle(viewer, article) {
  const r = article.xywh;
  const tiledImage = viewer.world.getItemAt(0);

  const viewportRect = tiledImage.imageToViewportRectangle(
    new OpenSeadragon.Rect(r.x, r.y, r.w, r.h)
  );

  viewer.viewport.fitBounds(viewportRect, true);

  document.querySelectorAll(".article-segment")
    .forEach(el => el.classList.remove("active"));

  document.querySelectorAll(`[article-part="${article.id}"]`)
    .forEach(el => el.classList.add("active"));
}

// ================================
// TOGGLE OCR
// ================================
function toggleArticleContent(artId) {
  document.querySelectorAll(".article-content").forEach(el => {
    el.classList.toggle("open", el.dataset.art === artId && !el.classList.contains("open"));
  });
}

// ================================
// START
// ================================
init();
</script>

</body>
</html>